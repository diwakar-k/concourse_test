resource_types:
- name: git-branches
  type: docker-image
  source:
    repository: vito/git-branches-resource
resources:
  - name: demo
    type: git-branches
    source:
      uri: https://github.com/diwakar-k/concourse_test.git
  - name: storage
    type: s3
    source:
    #   repository: 657757981076.dkr.ecr.us-east-1.amazonaws.com/test
      aws_access_key_id: {{aws-access-key}}
      aws_secret_access_key: {{aws-secret-key}}
      # Name of the bucket in S3 account
      bucket: rishi-demo
      region_name: ap-south-1  
jobs:
  - name: createpipelines
    public: false
    plan:
      - get: demo
        trigger: true
      - task: createpipelines
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: rguichard/fly
              tag: latest
          # This means a directory `source-repo/` will be mounted to the container in this task
          inputs:
            - name: demo
          # This ensures that the changes done as part of this task are retained in `source-repo/` for other tasks
          outputs:
            - name: source-repo
          run:
            path: /bin/sh
            args: 
              - "-e"
              - "-c"
              - |
                export NEW_VERSIONS=$(cat branches/branches)
                export OLD_VERSIONS=$(cat branches/removed)

                fly login -t your-concourse -c http://localhost:8080 -u concourse -p mysuperpassword

                for version in $NEW_VERSIONS; do
                sed "s/___BRANCH___/$version/g" demo/.ci/pipeline-demo.tmpl > demo/.ci/pipeline-app.result
                echo "Create pipeline branch $version"
                fly -t your-concourse sp -n -p app-$version -c demo/.ci/pipeline-app.result
                echo "Unpause pipeline branch $version"
                fly -t your-concourse up -p app-$version
                done

                for version in $OLD_VERSIONS; do
                echo "Delete pipeline branch $version"
                fly -t your-concourse dp -n -p app-$version
                done
              
      - put: storage
        inputs: 
          - source-repo
        

            